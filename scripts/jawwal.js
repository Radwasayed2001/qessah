let timerIdJ = null, wordTimerId = null;
function clearTimersJ() {
  clearInterval(timerIdJ);
  clearInterval(wordTimerId);
}
document.addEventListener('DOMContentLoaded', () => {
  const playersJawwal = loadPlayers();
  let settingsJawwal       = { time: 60, categories: [] };
  let order = [], idx = 0;
  let currentPlayerJawwal  = 0, correctCount = 0;
  const roundResultsJ = [];

  // ุนุชุจุฉ ุงูููู ุจุงููุณุจุฉ ููู delta ุนู baseline
  const TILT_THRESHOLD = 30;  
  let baselineBeta = null;
  let tiltHandled  = false;

  // DOM refs
  const timeSlider    = document.getElementById('timeSlider');
  const timeValueJ     = document.getElementById('timeValue');
  const catsJ          = [...document.querySelectorAll('.checkbox-list input')];
  const startBtnJ      = document.getElementById('startHeadsUp');
  const backSettingsJ  = document.getElementById('backToGamesBtnJ');

  const passName      = document.getElementById('headsUpPlayerName');
  const passCount     = document.getElementById('headsUpCount');
  const gameWord      = document.getElementById('headsUpWord');
  const gameTimer     = document.getElementById('headsUpTimer');
  const btnCorrect    = document.getElementById('btnCorrect');
  const btnSkip       = document.getElementById('btnSkip');

  const endCount      = document.getElementById('headsUpCountCorrect');
  const nextPlayerBtnJ = document.getElementById('btnNextPlayer');

  const resultsBody   = document.getElementById('headsUpResultsBody');
  const replayBtn     = document.getElementById('btnReplayHeadsUp');
  const backGameBtnJ   = document.getElementById('btnBackHeadsUp');

  // ููุณุญ ูู ุงููุคูุชุงุช
  

  // ุถุจุท ูุต ุงูุณูุงูุฏุฑ
  timeSlider.addEventListener('input', e => {
    const v = +e.target.value;
    settingsJawwal.time = v;
    timeValueJ.textContent = v === 60 ? '1 ุฏูููุฉ'
                          : v === 90 ? '1.5 ุฏูููุฉ'
                                     : '2 ุฏูุงุฆู';
  });

  // ุงูุนูุฏุฉ ูููุงุฆูุฉ
  backSettingsJ.onclick = () => showScreen('gamesScreen');

  // ุฒุฑ/ุงุจุฏุฃ
  startBtnJ.addEventListener('click', () => {
    settingsJawwal.categories = catsJ.filter(c => c.checked).map(c => c.value);
    if (!settingsJawwal.categories.length) {
       showAlert('warning','ุงุฎุชุฑ ูุฌููุนุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู!');
       return;
    }
    order = [];
    for (const cat of settingsJawwal.categories) {
      if (Array.isArray(WORDS[cat])) {
          order.push(...WORDS[cat]);
      } else {
          console.warn(`WORDS[${cat}] is undefined or not an array`);
      }
  }
  
    shuffle(order);
    idx = 0;
    currentPlayerJawwal = 0;
    roundResultsJ.length = 0;
    runTurn();
  });

  
  // ูุนุงูุฑุฉ ููุทุฉ ุงููุฑุฌุน ูุชุตููุฑ tiltHandled
  function resetTilt() {
    baselineBeta = null;
    tiltHandled  = false;
  }

  // ูุดู ุงูููู ุจุงููุณุจุฉ ููู baseline
  function onTilt(e) {
    if (baselineBeta === null) {
      baselineBeta = e.beta;
      return;
    }
    const delta = e.beta - baselineBeta;
    if (!tiltHandled && delta > TILT_THRESHOLD) {
      tiltHandled = true;
      nextWord();
      setTimeout(() => tiltHandled = false, 800);
    }
  }

  // ุจุฏุงูุฉ ุฏูุฑ ูุงุนุจ
  function runTurn() {
    clearTimersJ();
    correctCount = 0;
    passName.textContent  = `๐ฑ ุฃุนุทู ุงููุงุชู ุฅูู: ${playersJawwal[currentPlayerJawwal]}`;
    passCount.textContent = '3';
    showScreen('headsUpPassPhone');

    let c = 3;
    wordTimerId = setInterval(() => {
      passCount.textContent = --c;
      if (c <= 0) {
        clearInterval(wordTimerId);
        startRound();
      }
    }, 1000);
  }

  // ุจุฏุก ุงูุฌููุฉ
  function startRound() {
    clearTimersJ();
    resetTilt();
    showScreen('headsUpGameScreen');

    // ุฅุธูุงุฑ ุฃุฒุฑุงุฑ โ ูโ
    btnCorrect.style.display = btnSkip.style.display = 'inline-block';

    // ุชูุนูู ูุณุชูุน ุงูููู
    window.addEventListener('deviceorientation', onTilt);

    let timeLeft = settingsJawwal.time;
    gameTimer.textContent = `โฐ ${timeLeft}s`;
    timerIdJ = setInterval(() => {
      timeLeft--;
      gameTimer.textContent = `โฐ ${timeLeft}s`;
      if (timeLeft <= 0) endRound();
    }, 1000);

    nextWord();
  }

  // ุนุฑุถ ุงููููุฉ ุงูุชุงููุฉ
  function nextWord() {
    if (idx >= order.length) {
      idx = 0;
      shuffle(order);
    }
    gameWord.textContent = order[idx++];
  }

  // ุงูุฅุฌุงุจุฉ ุตุญูุญุฉ
  btnCorrect.addEventListener('click', () => {
    correctCount++;
    nextWord();
  });

  // ุชุฎุทู ูููุฉ
  btnSkip.addEventListener('click', nextWord);

  // ููุงูุฉ ุงูุฌููุฉ
  function endRound() {
    clearTimersJ();
    window.removeEventListener('deviceorientation', onTilt);
    btnCorrect.style.display = btnSkip.style.display = 'none';

    const name  = playersJawwal[currentPlayerJawwal];
    const score = correctCount * 5;
    const prev  = parseInt(localStorage.getItem(name)) || 0;
    const total = prev + score;
    localStorage.setItem(name, total);

    roundResultsJ.push({ name, correct: correctCount, score, total });
    endCount.textContent = correctCount;
    showScreen('headsUpEndTurn');
  }

  // ุงูุชุงูู ุฃู ุงููุชุงุฆุฌ
  nextPlayerBtnJ.addEventListener('click', () => {
    currentPlayerJawwal++;
    if (currentPlayerJawwal < playersJawwal.length) runTurn();
    else showResults();
  });

  // ุนุฑุถ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ
  function showResults() {
    roundResultsJ.sort((a,b) => b.correct - a.correct);
    resultsBody.innerHTML = roundResultsJ.map((r,i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.name}</td>
        <td>${r.correct}</td>
        <td>${r.score}</td>
        <td>${r.total}</td>
      </tr>
    `).join('');
    showScreen('headsUpResults');
  }

  // ุฅุนุงุฏุฉ ูุนุจ ุฃู ุนูุฏุฉ
  replayBtn.onclick   = () => showScreen('headsUpSettings');
  backGameBtnJ.onclick = () => showScreen('gamesScreen');
});

// ุชูููุจ ูุตูููุฉ
function shuffle(a) {
  return a.sort(() => Math.random() - 0.5);
}

const WORDS = {
  food: [
    'ุชูุงุญ','ููุฒ','ุจุฑุชูุงู','ุนูุจ','ูููู','ุฎูุฎ','ุฑูุงู','ูุฑุงููุฉ','ูุฑุฒ','ูุงูุฌู',
    'ุฃูุงูุงุณ','ุฌูุงูุฉ','ููููู','ุจุทูุฎ','ุชูู','ุจุงุฐูุฌุงู','ุฎูุงุฑ','ุทูุงุทู','ุฌุฒุฑ','ุจุทุงุทุณ',
    'ุจุฑูููู','ุณุจุงูุฎ','ุฌุฒุฑ_ุฃุตูุฑ','ุจุตู','ุซูู','ุฒูุฌุจูู','ุฌุฑุฌูุฑ','ุฎุณ','ุจูุฏููุณ','ูุนูุงุน',
    'ุฑูุญุงู','ุฒุนุชุฑ','ูููู_ุฑููู','ุฎูุงุฑ_ูุฎูู','ุฒูุชูู','ุฌูุจุฑู','ุณูุทุฉ','ุดูุฑุจุฉ','ุจูุชุฒุง','ุจุฑุฌุฑ',
    'ุดุงูุฑูุง','ุณูุฏููุชุด','ูุจุณุฉ','ููุฑููุฉ','ูุณูุณู','ุฑุฒ','ุจุฑุบู','ุชูุฑ','ูุนู','ุจุณุทุฑูุฉ'
  ],
  places: [
    'ุญุฏููุฉ','ูุทุงุฑ','ูุณุชุดูู','ูุฏุฑุณุฉ','ุฌุงูุนุฉ','ููุชุจุฉ','ูุชุญู','ุณูููุง','ูุณุฑุญ','ูุทุนู',
    'ูููู','ุณูู','ูุญุทุฉ_ูุทุงุฑ','ูุญุทุฉ_ุญุงููุงุช','ูููุงุก','ุดุงุทุฆ','ุฌุจู','ูุงุฏู','ููุฑ','ุจุญูุฑุฉ',
    'ุฌุฒูุฑุฉ','ูุฑูุฉ','ูุฏููุฉ','ุนุงุตูุฉ','ุดุงุฑุน','ุจุฑุฌ','ูุตุฑ','ููุนุฉ','ูุนุจุฏ','ูููุณุฉ',
    'ุฌุงูุน','ููุฏู','ููุชุฌุน','ูุณุชูุฏุน','ูุตูุน','ูุฒุฑุนุฉ','ููุนุจ','ููุงูู','ุญุฏููุฉ_ุงูุญููุงู','ููุชุจุฉ_ุฑูููุฉ',
    'ุณุงุญุฉ','ูุฑูุฒ_ุชุณูู','ูุญููุฉ','ูุฎูู','ุฎููุฉ','ูุบุงุฑุฉ','ููู','ุบุงุจุฉ','ุตุญุฑุงุก','ูุงุฏู'
  ],
  animals: [
    'ุฃุณุฏ','ููุฑ','ููู','ุฒุฑุงูุฉ','ุซุนูุจ','ุฐุฆุจ','ูุฑุฏ','ุฎูุฒูุฑ','ุจูุฑุฉ','ุญุตุงู',
    'ุฌูู','ูุงุนุฒ','ุฎุฑูู','ุฏุฌุงุฌ','ุฏูู','ุจุท','ูุฒุฉ','ุจุทุฉ','ุณููุฉ','ุญูุช',
    'ุฏูููู','ูุฑุด','ุณูุญูุงุฉ','ุชูุณุงุญ','ุถูุฏุน','ุนูุฑุจ','ูุญูุฉ','ูููุฉ','ุนูุงุจ','ุตูุฑ',
    'ุจููุฉ','ุจุทุฑูู','ููุบุฑ','ุจุงูุฏุง','ุฑุงููู','ูุฃุฑ','ุฌุฑุฐ','ูุงูุณุชุฑ','ุฎูุฒูุฑ_ุบูููุง','ููุณ',
    'ุทุงููุณ','ุฏูู_ุฑููู','ุญูุงุฑ','ุจุบู','ูุงููู','ุธุจู','ุฒูุฌุจูู' // ูุซุงู ุนูู ูููุฉ ุฅุถุงููุฉ
  ],
  sports: [
    'ูุฑุฉ_ูุฏู','ุชูุณ','ูุฑุฉ_ุณูุฉ','ุณุจุงุญุฉ','ุฌุฑู','ุฏุฑุงุฌุงุช','ูุฑุฉ_ุทุงุฆุฑุฉ','ููุงููุฉ','ุฌูุฏู','ุชุงููููุฏู',
    'ูููู','ุฑุฌุจู','ุจูุณุจูู','ูุฑูููุช','ุบููู','ุชุฒูุฌ','ุชูุณ_ุทุงููุฉ','ุจููููุฌ','ูุฑูุณูุฉ','ุชุฑูุงุชููู',
    'ูุงุฑุงุซูู','ููุบุง','ุจููุงุชุณ','ุฌูุจุงุฒ','ุฒููุจุง','ูุฑููุงู','ุณุจุงู_ุฎูู','ุฑูุงูุฉ','ุชุณูู','ุตูุฏ',
    'ูุฑุฉ_ูุงุก','ูุฑุฉ_ูุฏ','ุฑูุต','ุงูุฑูุงุถุงุช_ุงูุฅููุชุฑูููุฉ','ุณูููุฑ','ุจููุงุฑุฏู','ุบูุต','ุฑูุถ','ููุฒ_ุนุงูู','ููุฒ_ูุถูุงุฑ'
  ],
  clothes: [
    'ูููุต','ุจูุทุงู','ูุณุชุงู','ุชููุฑุฉ','ุฌุงููุช','ุณุชุฑุฉ','ูุนุทู','ุญุฐุงุก','ุญุฐุงุก_ุฑูุงุถู','ูุจุนุฉ',
    'ูุดุงุญ','ููุงุฒุงุช','ุจููุณุฑ','ููุฌููุง','ูุธุงุฑุฉ_ุดูุณูุฉ','ุญุฒุงู','ุฌูุงุฑุจ','ุจุฏูุฉ','ุชูุดูุฑุช','ุจูุฌุงูุง',
    'ูุฆุฒุฑ','ุดุงู','ุฌุฑุฒุฉ','ูุจูุงุจ','ุญุฐุงุก_ุฌูุฏ','ุดุจุดุจ','ุจููุฒุฉ','ุฌููุฒ','ุดูุฑุช','ุจููุง'
  ],
  produce: [
    'ุฎุณ','ุฎูุงุฑ','ุทูุงุทู','ุฌุฒุฑ','ุจุทุงุทุณ','ุจุตู','ุซูู','ุฒูุฌุจูู','ูููู','ุจุฑูููู',
    'ูุฑูุจูุท','ุณุจุงูุฎ','ุฌุฑุฌูุฑ','ูุฑูุณ','ุจุงุฐูุฌุงู','ููุณุง','ูุฑุน','ุจุงุฒูุงุก','ุฐุฑุฉ','ูุงุตูููุงุก',
    'ุนุฏุณ','ุญูุต','ูุทุฑ','ูุฌู','ุจุงุฒููุงุก','ุจุงููุฉ','ููุจูุง','ุจุงููุฉ','ุจุงุฒูุงุก_ุฎุถุฑุงุก','ุฐุฑุฉ_ุญููุฉ'
  ],
  drinks: [
    'ูุงุก','ุดุงู','ูููุฉ','ุนุตูุฑ_ุจุฑุชูุงู','ุนุตูุฑ_ุชูุงุญ','ุนุตูุฑ_ููููุฒุง','ุญููุจ','ุดููููุงุชุฉ_ุณุงุฎูุฉ','ูููุชูู','ุณูุฏุง',
    'ุจูุจุณู','ูููุงูููุง','ุณุจุฑุงูุช','ูููุชุงูุง','ุงุณุจุฑูุณู','ูุงุชูู','ูุงุจุชุดููู','ููููุชู','ููููุดูู','ุนุฑูุณูุณ',
    'ุนุฑู','ูุจูุฐ','ุฌุนุฉ','ูุดุฑูุจ_ุทุงูุฉ','ุนุตูุฑ_ุฑูุงู','ุนุตูุฑ_ูุงูุฌู','ุนุตูุฑ_ูุฑุฒ','ุนุตูุฑ_ุฃูุงูุงุณ','ูููููุงุถุฉ','ุดุงู_ุฃุฎุถุฑ',
    'ุดุงู_ูุฑูุฏูุฉ','ุดุงู_ูุนูุงุน'
  ],
  household: [
    'ูุฑุณู','ุทุงููุฉ','ุณุฑูุฑ','ุฃุฑููุฉ','ุฎุฒุงูุฉ','ุฏููุงุจ','ุซูุงุฌุฉ','ูุฑู','ูููุฑููู','ุบุณุงูุฉ',
    'ูููุงุฉ','ูุงููุณูุฉ','ูุฑูุญุฉ','ูููู','ุณุฎุงู','ูุตุจุงุญ','ูููุงุฉ','ูุฏุฑ','ูุบุณูุฉ','ููุนุฏ',
    'ุฑู','ุณุชุงุฑุฉ','ุณุฌุงุฏุฉ','ููุญุฉ','ูุฑุขุฉ','ุณุงุนุฉ','ุชููุฒููู','ุญุงุณูุจ','ุฌูุงุฒ_ุตูุช','ูุญูุตุฉ'
  ],
  vehicles: [
    'ุณูุงุฑุฉ','ุฏุฑุงุฌุฉ','ุญุงููุฉ','ูุทุงุฑ','ุทุงุฆุฑุฉ','ุณูููุฉ','ูุงุฑุจ','ูุฑูุจ','ุชุฑู','ุดุงุญูุฉ',
    'ุฏุฑุงุฌุฉ_ูุงุฑูุฉ','ุณููุชุฑ','ุชุฑุงู','ูุชุฑู','ูุทุงุฑ_ุณุฑูุน','ุฏุฑุงุฌุฉ_ููุงุฆูุฉ','ุญุงููุฉ_ูุฏุงุฑุณ','ุดุงุญูุฉ_ููุงูุฉ','ุฑุงูุนุฉ','ุฌุฑุงุฑ',
    'ุณูุงุฑุฉ_ุฃุฌุฑุฉ','ููููุฒูู','ูุฎุช','ุฒูุฑู','ูุงููุฉ','ุตุงุฑูุฎ','ุฏุฑูู','ูุงุฐูุฉ','ุณููู','ุฒูุฑู_ูุฌุฏุงู'
  ],
  cities: [
    'ุฑูุงุถ','ุฌุฏุฉ','ููุฉ','ุงููุฏููุฉ','ุฏูุดู','ุจูุฑูุช','ุงููุงูุฑุฉ','ุจุบุฏุงุฏ','ุงูุงุณููุฏุฑูุฉ','ุงูุฏูุญุฉ',
    'ุนูุงู','ุงูุฎุฑุทูู','ุฑุงู ุงููู','ุงูุฏุงุฑ_ุงูุจูุถุงุก','ุทูุฌุฉ','ุชููุณ','ุงูุฌุฒุงุฆุฑ','ุทุฑุงุจูุณ','ุงูููุงูุฉ','ูุณูุท',
    'ุงููุฏุณ','ููุฏู','ุจุงุฑูุณ','ูููููุฑู','ุฑููุง','ูุฏุฑูุฏ','ุจุฑููู','ููุณ_ุฃูุฌููุณ','ุณุงู_ุจุงููู','ุจููู'
  ],
  cartoons: [
    'ููู_ูุงูุณ','ุจุงุชูุงู','ุณุจุงูุฏุฑูุงู','ุณููุจุณูู','ุชูู_ูุฌูุฑู','ุจููุงุชุดู','ุณูุงุญู_ููุฌุง','ุจุงุจ_ุณูุงุญุฉ','ุจุงุบุฒ_ุจุงูู','ุจูุชูุฒ',
    'ูููุฌุง_ุฌุณุชุฑู','ูุงุฑุฒ','ุญุฑุจ_ุงููุฌูู','ุจูููููู','ุฏูุฑุง','ุขูุง_ุฅูุณุง','ูููุงุฑู','ุชุดุงุฑูู_ุดุงุจูู','ุชูู_ูููุงูุฏ','ูุงุฌูู_ุฌููุฒ'
  ],
  games: [
    'ุดุทุฑูุฌ','ุฏููููู','ููููุจููู','ูุนุจุฉ_ุงููุฑู','ุจุงุฒููุง','ุณูููุชูุฑ','ุจููุฑ','ูุงูููุฑุงูุช','ููุฑุชูุงูุช','ุจุจุฌู',
    'ููุฏ','ุฃููุฑูุงุชุด','ููุบ_ุฃูู_ููุฌููุฏุฒ','ูููุง','ููุฏ_ููุฑ_ุณุจูุฏ','ุชููู','ุณุชุฑูุช_ูุงูุชุฑ','ุจูุจุฑ','ุณููู','ุชูุชุงูููู'
  ],
  jobs: [
    'ุทุจูุจ','ูููุฏุณ','ูุนูู','ูุญุงูู','ุฌุฒุงุฑ','ุฎุจุงุฒ','ุณุงุฆู','ูุฒุงุฑุน','ุทูุงุฑ','ุจุญุงุฑ',
    'ุดุฑุทู','ุฌูุฏู','ุญูุงู','ูุบูู','ุฑุงูุต','ุฑุณุงู','ูุงุชุจ','ุตุญูู','ูุชุฑุฌู','ูุทูุฑ_ุจุฑูุฌูุงุช'
  ],
  langs: [
    'ุนุฑุจูุฉ','ุงูุฌููุฒูุฉ','ูุฑูุณูุฉ','ุฅุณุจุงููุฉ','ุฃููุงููุฉ','ุฅูุทุงููุฉ','ุฑูุณูุฉ','ูุงุจุงููุฉ','ุตูููุฉ','ููุฑูุฉ',
    'ุชุฑููุฉ','ููููุฏูุฉ','ููุฏูุฉ','ูุงุฑุณ','ุจุฑุชุบุงููุฉ','ุฅูุฏูููุณูุฉ','ูุงููุฒูุฉ','ููุชูุงููุฉ','ุฃุฑุฏูุฉ','ูุงูุทูุฉ'
  ],
  countries: [
    'ุงูุณุนูุฏูุฉ','ูุตุฑ','ุงูุนุฑุงู','ุณูุฑูุง','ุงูุฃุฑุฏู','ูุจูุงู','ุชููุณ','ุงูุฌุฒุงุฆุฑ','ุงููุบุฑุจ','ุงูุฅูุงุฑุงุช',
    'ูุทุฑ','ุงููููุช','ุนูุงู','ุงูุจุญุฑูู','ุชุฑููุง','ูุฑูุณุง','ุฃููุงููุง','ุฅูุทุงููุง','ุฅุณุจุงููุง','ุงูููุงูุงุช_ุงููุชุญุฏุฉ',
    'ููุฏุง','ุฃุณุชุฑุงููุง','ุงูุจุฑุงุฒูู','ุงูุฃุฑุฌูุชูู','ุงูููุฏ','ุงูุตูู','ุงููุงุจุงู','ููุฑูุง_ุงูุฌููุจูุฉ','ุงูููุณูู','ุฑูุณูุง'
  ]
};
function startJawwalGame(){
  if (players.length < 2) {
    showAlert('error', 'ูุนุจุฉ ุงูุชูุงุฒู ุชุชุทูุจ ูุงุนุจูู 2 ุนูู ุงูุฃูู  ');
    return; 
  } 
  showScreen('headsUpSettings')
}
